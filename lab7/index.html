
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="duilec">
      
      
        <link rel="canonical" href="https://github.com/duilec/gpnu_dxxy_xv6/lab7/">
      
      
        <link rel="prev" href="../lab6/">
      
      
        <link rel="next" href="../resource/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>lab7 外部设备 - gpnu-dxxy-xv6</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab7" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="gpnu-dxxy-xv6" class="md-header__button md-logo" aria-label="gpnu-dxxy-xv6" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            gpnu-dxxy-xv6
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              lab7 外部设备
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/duilec/gpnu_dxxy_xv6" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    duilec/gpnu_dxxy_xv6
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab0/" class="md-tabs__link">
        
  
    
  
  lab0 启动Xv6

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab1/" class="md-tabs__link">
        
  
    
  
  lab1 工具程序

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab2/" class="md-tabs__link">
        
  
    
  
  lab2 系统调用

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab3/" class="md-tabs__link">
        
  
    
  
  lab3 多线程

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab4/" class="md-tabs__link">
        
  
    
  
  lab4 页表实验

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab5/" class="md-tabs__link">
        
  
    
  
  lab5 锁的机制

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../lab6/" class="md-tabs__link">
        
  
    
  
  lab6 文件系统

      </a>
    </li>
  

      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
    
  
  lab7 外部设备

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../resource/" class="md-tabs__link">
        
  
    
  
  资源

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="gpnu-dxxy-xv6" class="md-nav__button md-logo" aria-label="gpnu-dxxy-xv6" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    gpnu-dxxy-xv6
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/duilec/gpnu_dxxy_xv6" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    duilec/gpnu_dxxy_xv6
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab0 启动Xv6
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab1 工具程序
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab2 系统调用
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab3 多线程
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab4 页表实验
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab5 锁的机制
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lab6 文件系统
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    lab7 外部设备
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    lab7 外部设备
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      背景
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      网络设备驱动程序
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      网络套接字
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    资源
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      背景
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      网络设备驱动程序
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      网络套接字
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="lab7">Lab7: 外部设备<a class="headerlink" href="#lab7" title="Permanent link">&para;</a></h1>
<p>在这个实验中，你将为网络接口卡（NIC）编写一个设备驱动程序，并向 xv6 添加对 UDP 网络套接字的支持。</p>
<p>获取用于实验的 xv6 源代码并检出 net 分支：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>git<span class="w"> </span>fetch
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>net
</code></pre></div></td></tr></table></div>
<h2 id="_1">背景<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在编写代码之前，你可能会发现有必要查阅 xv6 书籍中的 "Chapter 4: Traps and device drivers" 和 "Section 7.13: File descriptor layer"，以及网络方面的讲座笔记。</p>
<p>我们将使用名为 E1000 的虚拟网络设备来处理网络通信。对于 xv6（以及你编写的驱动程序），E1000 看起来就像连接到真实以太网局域网（LAN）的真实硬件一样。但实际上，你的驱动程序将与 qemu 提供的仿真相连，该仿真通过 qemu 也进行了仿真。在这个局域网中，xv6（"guest"）的 IP 地址为 10.0.2.15。局域网中唯一的其他（模拟的）计算机的 IP 地址为 10.0.2.2。qemu 安排当 xv6 使用 E1000 发送数据包到 10.0.2.2 时，实际上是将其传递给运行 qemu 的（真实）计算机上的适当应用程序（"host"）。</p>
<p>我们将使用 QEMU 的用户模式网络堆栈，因为它不需要管理权限即可运行。QEMU 的文档在这里提供了有关用户网络的更多信息。我们已经更新了 Makefile，以启用 QEMU 的用户模式网络堆栈和虚拟 E1000 网络卡。</p>
<p>我们还配置了 QEMU 的网络堆栈，以将所有传入和传出的数据包记录到你的实验目录中的 packets.pcap 中。审查这些记录可能有助于确认 xv6 是否发送和接收了你期望的数据包。要获取捕获的数据包的十六进制/ASCII 转储，请像这样使用 tcpdump：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>tcpdump<span class="w"> </span>-XXnr<span class="w"> </span>packets.pcap
</code></pre></div></td></tr></table></div>
<p>最后，我们已经为你提供了处理以太网、IP、UDP 和 ARP 包头的所有所需代码。确保在 kernel/net.c 和 kernel/net.h 中审查这些代码。还提供了一个简单的抽象，称为 mbuf，用于存储和管理数据包负载。它将在整个实验任务中使用。</p>
<h2 id="_2">网络设备驱动程序<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>难度：困难</p>
<p>在这部分任务中，你将完成 E1000 网络驱动程序的实现。到目前为止，已经提供了用于发现和初始化设备以及处理中断的代码，但还没有发送和接收数据包。</p>
<p>浏览 Intel 的 E1000 软件开发手册。该手册涵盖了几个密切相关的以太网控制器。QEMU 模拟的是 82540EM。现在可以略读第 2 章以了解设备的情况。为了编写你的驱动程序，你需要熟悉第 3 章和第 14 章，以及第 4.1 节（不包括 4.1 的子节）。你还需要使用第 13 章作为参考。其他章节主要涵盖你的驱动程序不必与之交互的 E1000 组件。现在不必担心细节；只需了解文档的结构，以便稍后查找。请记住，E1000 有许多高级功能，但你可以忽略其中大多数。只需要一小部分基本功能即可完成实验任务。</p>
<p><strong>你的任务：</strong></p>
<p>你的任务是实现发送和接收数据包的支持。你需要在 kernel/e1000.c 中填写 e1000_recv() 和 e1000_transmit() 中的缺失部分。</p>
<p>发送和接收数据包都由在内存中 xv6 和 E1000 之间共享的描述符队列管理。这些队列为 E1000 提供了进行 DMA（即传输）数据包数据的内存位置的指针。它们实现为循环数组，这意味着当卡片或驱动程序到达数组的末尾时，它会回到开始。一个常见的缩写是将接收数据结构称为 RX，将传输数据结构称为 TX。</p>
<p>当新数据包到达时，E1000 会生成中断。你的接收代码必须扫描 RX 队列以处理已到达的每个数据包，并通过调用 net_rx() 将其 mbuf 传递给协议层。struct rx_desc 描述了描述符的格式。然后，你需要分配一个新的 mbuf，并将其程序到描述符中，以便 E1000 知道在以后的某个时候当数据包到达相同的位置时应放置在何处。</p>
<p>当协议层调用 e1000_transmit() 时，会请求发送数据包。你的传输代码必须将 mbuf 加入 TX 队列。这包括从内存中提取负载的位置和长度，并将这些信息编码到 TX 队列中的描述符中。struct tx_desc 描述了描述符的格式。你需要确保 mbuf 在传输完成后最终被释放（NIC 可以在描述符中编码一个通知位以指示这一点）。</p>
<p>除了读取和写入描述符的循环数组之外，你还需要通过内存映射 I/O 与 E1000 进行交互，以便检测到接收路径上的新描述符，并通知 E1000 新描述符已在传输路径上提供。设备的 I/O 指针存储在 regs 中，并且可以作为控制寄存器的数组进行访问。你将需要特别使用 E1000_RDT 和 E1000_TDT 的索引。</p>
<p><strong>提示：</strong></p>
<p>确保考虑到锁定。通常，当内存是共享的时候，需要使用锁来同步访问。</p>
<p>以下是一些发送的提示：</p>
<ul>
<li>对于传输，首先获取当前的环位置，使用 E1000_TDT。</li>
<li>然后检查环是否溢出。如果当前描述符中未设置 E1000_TXD_STAT_DD，则表示先前的传输仍在进行中，因此返回错误。</li>
<li>否则，使用 mbuffree() 释放上一个使用当前描述符传输的 mbuf（如果有的话）。</li>
<li>然后填充描述符，提供新 mbuf 的头指针和长度。设置必要的 cmd 标志（阅读 E1000 手册）。并将新 mbuf 的指针保存在一个变量中，以便稍后释放。</li>
<li>最后，通过将 E1000_TDT 加 1 取模 TX_RING_SIZE 来更新环位置。</li>
<li>如果传输成功地将 mbuf 添加到环中，则返回 0（否则，调用方将释放 mbuf）。如果失败（例如，没有可用的描述符来传输 mbuf），则返回 -1（以便调用方知道要释放 mbuf）。</li>
</ul>
<p>以下是一些接收的提示：</p>
<ul>
<li>首先获取下一个环位置，使用 E1000_RDT 加一取模 RX_RING_SIZE。</li>
<li>然后检查是否有新数据包可用，通过检查描述符的状态部分中的 E1000_RXD_STAT_DD 位。如果没有，停止。</li>
<li>否则，更新 mbuf 的长度以匹配描述符中报告的长度（例如，使用 mbufput()）。使用 net_rx() 将 mbuf 传递到协议层。（e1000_init() 最初为接收环中的每个槽分配了一个 mbuf。）</li>
<li>然后分配一个新的 mbuf（因为 net_rx() 可能会占用传递给它的 mbuf），并将其头指针程序到描述符中。将描述符的状态位清零。</li>
<li>最后，通过写入来更新 E1000_RDT 寄存器以到达下一个位置。</li>
</ul>
<p><strong>最后：</strong></p>
<p>当你完成了 E1000 驱动程序的缺失部分的实现后，以下是一些测试的提示。我们提供了一个工具，可以通过键入 <code>make ping</code> 在终端中运行它。请小心在运行它的同一台机器上运行它，该机器正在运行 QEMU 中的 xv6 内核实例。ping 工具将每秒发送一个 UDP 数据包到你的网络堆栈。在 e1000_recv() 函数中添加 printf 来验证你是否收到每个 UDP ping 数据包。特别是，检查是否可以接收超过 16 个数据包（描述符环的大小）。如果遇到问题，检查 packets.pcap 是否有助于查看你的 E1000 驱动程序是否正常工作。在 e1000_transmit() 和 e1000_recv() 中添加 printf 也可能有助于调试。</p>
<h2 id="_3">网络套接字<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>难度：困难</p>
<p>现在你已经完成了 E1000 驱动程序，你需要支持用户空间应用程序。为了帮助你，提供了一个名为 nettests 的测试用户程序，但你首先需要实现对网络套接字的支持，以便它可以与 xv6 交互。</p>
<p>网络套接字是 OS 网络的标准抽象，类似于文件。套接字通过普通的文件描述符（就像文件、管道和设备一样）进行访问。从套接字文件描述符读取接收一个数据包，而写入它则发送一个数据包。如果当前没有可接收的数据包，读取者必须阻塞并等待下一个数据包到达（即允许重新调度到另一个进程）。在这个实验中，你将实现一个支持 UDP 网络协议的精简版本的套接字。</p>
<p>每个网络套接字只接收特定本地和远程 IP 地址和端口号组合的数据包，并且 xv6 需要支持多个套接字。可以通过 connect 系统调用创建套接字并将其绑定到请求的地址和端口。此系统调用的实现在 kernel/sysfile.c 中。在 kernel/sysnet.c 中的代码 sockalloc() 和相关函数。</p>
<p>注意所提供的数据结构；为每个套接字创建一个 struct sock 对象。sockets 是所有活动套接字的单链表。它有助于查找要传递新接收到的数据包的套接字。此外，每个套接字对象维护一个等待接收的 mbuf 队列。收到的数据包将保留在这些队列中，直到读取() 系统调用将它们出队。</p>
<p><strong>你的任务：</strong></p>
<p>你的任务是实现支持网络套接字所需的缺失功能。这包括添加和集成支持读取、写入和关闭套接字的函数。还包括完成 sockrecvudp() 的实现，每次接收到新的 UDP 数据包时都会调用它。为了实现这一点，请填写 kernel/sysnet.c 中的缺失部分，并修改 kernel/file.c 来调用你的套接字方法。</p>
<p><strong>提示：</strong></p>
<p>以下是一些提示：</p>
<ul>
<li>仔细阅读 kernel/pipe.c。它提供了实现一种文件类型的示例。套接字是另一种文件类型，它们将需要相同的文件方法。</li>
<li>在 kernel/defs.h 中定义你的套接字方法，包括读取、写入和关闭。通过检查套接字类型是否为 FD_SOCK，将每个方法集成到 kernel/file.c 中的适当调用点。</li>
<li>对于读取方法，请使用 mbufq_empty() 检查 rxq 是否为空，如果是，请使用 sleep() 等待直到 mbuf 入队（不要忘记将 sleep() 调用包装到 while 循环中，因为其他使用 sleep() 的地方也是如此）。使用 mbufq_pophead，从 rxq 弹出 mbuf，并使用 copyout() 将其负载移动到用户内存中。最后使用 mbuffree() 释放 mbuf 完成。</li>
<li>对于写入方法，请分配一个新的 mbuf，确保为 UDP、IP 和以太网标头保留足够的头部空间。使用 mbufput() 和 copyin() 将负载从用户内存传输到 mbuf 中。最后，使用 net_tx_udp() 发送 mbuf。</li>
<li>对于关闭方法，请从 sockets 列表中移除套接字。然后，释放套接字对象。在释放 struct sock 之前，请务必先释放任何未读取的 mbuf。</li>
<li>对于 sockrecvudp()，确定哪个套接字（如果有）可以处理 mbuf，并将其传递到适当的 rxq。使用 wakeup() 唤醒任何等待的读取器。</li>
<li>不要忘记在整个过程中考虑到锁定！</li>
</ul>
<p><strong>将所有内容整合起来：</strong></p>
<p>当你完成后，请运行测试程序。如果一切正常，你将获得以下输出：</p>
<p>（在主机的一个终端上）</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>make<span class="w"> </span>server
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>python2<span class="w"> </span>server.py<span class="w"> </span><span class="m">26099</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>listening<span class="w"> </span>on<span class="w"> </span>localhost<span class="w"> </span>port<span class="w"> </span><span class="m">26099</span>
</code></pre></div></td></tr></table></div>
<p>（然后在另一个终端上运行 xv6）</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>nettests
</code></pre></div></td></tr></table></div>
<p>如果遇到任何问题，请尝试检查 packets.pcap，以查看你的 E1000 驱动程序是否正常工作。在 e1000_transmit() 和 e1000_recv() 中添加 printf 也可能有助于调试。</p>
<p>这完成了实验。提交你的更改，并在实验目录中键入 <code>make handin</code> 以提交你的实验。</p>
<p>请运行 <code>make grade</code> 来确保你的代码通过了所有测试。在运行 <code>make handin</code> 之前提交任何修改过的源代码。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; duilec
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/duilec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<elelsyqrlc42@163.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top", "search.suggest", "search.highlight", "navigation.expand", "search.share"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
    
  </body>
</html>